{% extends "base.html" %}

{% block title %}Enne - AI-Assisted CRM{% endblock %}
{% block page_title %}Assistant{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 400px;
        background: var(--background);
    }

    .chat-header {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow-light);
    }

    /* Typing indicator now shows immediately when created */
</style>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col chat-container">

    <!-- Chat Messages Area -->
    <div class="flex-1 overflow-hidden relative">
        <div id="chat-messages" class="h-full overflow-y-auto space-y-6 px-4 py-6">


        </div>

        <!-- Scroll to bottom button -->
        <button id="scroll-to-bottom" class="scroll-to-bottom-btn hidden" title="Scroll to bottom">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
        </button>
    </div>

    <!-- Chat Input -->
    <div class="chat-input-container-modern">
        <form id="chat-form" class="chat-form-modern">
            <div class="chat-input-wrapper">
                <textarea
                    id="message-input"
                    name="message"
                    placeholder="Ask me anything ..."
                    class="chat-input-modern"
                    autocomplete="off"
                    required
                    rows="1"
                ></textarea>
                <button type="submit" class="send-button-modern" title="Send message">
                    <svg class="send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <svg class="check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>
            </div>
            <div class="chat-input-footer">
                <!-- Removed typing indicator - now shows in chat area -->
            </div>
        </form>
    </div>
</div>

<!-- Message Templates -->
<template id="user-message-template">
    <div class="message-container user">
        <div class="chat-bubble-modern chat-bubble-user">
            <div class="message-content" id="user-message-content"></div>
            <div class="message-timestamp">
                <span class="message-time" id="user-message-time"></span>
            </div>
        </div>
        <div class="avatar-modern avatar-user-enhanced">
            <span class="avatar-initial" id="user-avatar-initial">U</span>
        </div>
    </div>
</template>

<template id="assistant-message-template">
    <div class="message-container assistant">
        <div class="avatar-modern avatar-assistant">
            <span class="ai-stars">‚ú®</span>
        </div>
        <div class="message-content-wrapper">
            <div class="chat-bubble-modern chat-bubble-assistant">
                <div class="message-meta">
                    <span id="command-badge" class="command-badge hidden">
                        Command Detected
                    </span>
                    <span id="provider-badge" class="command-badge">
                        Claude
                    </span>
                </div>
                <div class="message-content" id="assistant-message-content"></div>
                <div id="execution-result" class="execution-result hidden"></div>
                <div class="message-timestamp">
                    <span class="message-time" id="assistant-message-time"></span>
                </div>
            </div>
            <!-- Entity cards OUTSIDE bubble for proper sizing -->
            <div id="entity-card-container" class="entity-card-container hidden"></div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// Check authentication before loading assistant page
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user_data');

    if (!token || !userData) {
        // No authentication data, redirect to login
        window.location.href = '/login';
        return;
    }

    // Verify token is still valid by making a test API call
    fetch('/api/v1/auth/me', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            // Token is invalid, clear storage and redirect
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_data');
            window.location.href = '/login';
        }
    })
    .catch(error => {
        console.log('Token verification failed, assuming valid');
    });
});

// Chat functionality
let messageHistory = [];

function insertCommand(command) {
    document.getElementById('message-input').value = command;
    document.getElementById('message-input').focus();
}

function showTyping() {
    // Create dynamic thinking indicator
    const thinkingIndicator = document.createElement('div');
    thinkingIndicator.id = 'typing-indicator';
    thinkingIndicator.className = 'message-container assistant typing-indicator';
    thinkingIndicator.innerHTML = `
        <div class="avatar-modern avatar-assistant">
            <span class="ai-stars">‚ú®</span>
        </div>
        <div class="thinking-bubble">
            <div class="thinking-content">
                <span class="thinking-text">AI is thinking</span>
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('chat-messages').appendChild(thinkingIndicator);
    animateSendButton();
    scrollToBottom();
}

function hideTyping() {
    const thinkingIndicator = document.getElementById('typing-indicator');
    if (thinkingIndicator) {
        thinkingIndicator.remove();
    }
}

function addUserMessage(message) {
    const template = document.getElementById('user-message-template');
    const clone = template.content.cloneNode(true);

    // Format message content
    clone.getElementById('user-message-content').innerHTML = formatMessage(message);

    // Add timestamp
    clone.getElementById('user-message-time').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    // Set user initial from localStorage
    const userData = localStorage.getItem('user_data');
    let userInitial = 'U';
    if (userData) {
        try {
            const user = JSON.parse(userData);
            userInitial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
        } catch (e) {
            console.log('Could not parse user data');
        }
    }
    clone.getElementById('user-avatar-initial').textContent = userInitial;

    const messageElement = clone.querySelector('.message-container');
    document.getElementById('chat-messages').appendChild(clone);

    scrollToBottom();
}

function addAssistantMessage(response) {
    const template = document.getElementById('assistant-message-template');
    const clone = template.content.cloneNode(true);

    // Set main content with rich formatting
    clone.getElementById('assistant-message-content').innerHTML = formatMessage(response.response);

    // Add timestamp
    clone.getElementById('assistant-message-time').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    // Set provider badge
    clone.getElementById('provider-badge').textContent = response.provider || 'AI';

    // Command badge disabled for cleaner UI
    // if (response.command_detected) {
    //     const commandBadge = clone.getElementById('command-badge');
    //     commandBadge.classList.remove('hidden');
    //     commandBadge.textContent = `${response.command_type} detected`;
    // }

    // Show execution result if available (but not for clarifications)
    if (response.execution_result) {
        const resultDiv = clone.getElementById('execution-result');
        const cardContainer = clone.getElementById('entity-card-container');

        if (response.execution_result.success) {
            // Check if we have entity data to display as a card
            if (response.execution_result.entity_type && response.execution_result.result) {
                // Render entity card
                cardContainer.classList.remove('hidden');
                cardContainer.innerHTML = renderEntityCard(
                    response.execution_result.entity_type,
                    response.execution_result.action,
                    response.execution_result.result
                );
                // Hide the text execution result since we're showing a card
                resultDiv.classList.add('hidden');
            } else {
                // Fallback to text-only result
                resultDiv.classList.remove('hidden');
                resultDiv.classList.add('execution-result');
                resultDiv.classList.remove('execution-error');
                resultDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600">‚úÖ</span>
                        <span class="font-medium">Action Completed:</span>
                        <span>${response.execution_result.message}</span>
                    </div>
                `;
            }
        } else if (response.execution_result.requires_clarification) {
            // Don't show error for clarifications - let AI handle it naturally
            resultDiv.classList.add('hidden');
        } else {
            // Show real errors
            resultDiv.classList.remove('hidden');
            resultDiv.classList.add('execution-error');
            resultDiv.classList.remove('execution-result');
            resultDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-red-600">‚ùå</span>
                    <span class="font-medium">Error:</span>
                    <span>${response.execution_result.error}</span>
                </div>
            `;
        }
    }

    const messageElement = clone.querySelector('.message-container');
    document.getElementById('chat-messages').appendChild(clone);

    scrollToBottom();
}

// Enhanced message formatting with markdown support
function formatMessage(message) {
    // Clean up excessive spacing first
    let cleaned = message
        // Remove excessive newlines (more than 2 consecutive)
        .replace(/\n{3,}/g, '\n\n')
        // Remove trailing spaces from lines
        .replace(/ +$/gm, '')
        // Remove leading/trailing whitespace
        .trim();

    // Split into paragraphs for better handling
    let paragraphs = cleaned.split(/\n\n+/);

    let formatted = paragraphs
        .map(paragraph => {
            // Process each paragraph individually
            let p = paragraph.trim();
            if (!p) return '';

            // Apply markdown formatting to the paragraph
            p = p
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')

                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')

                // Code blocks
                .replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                    const language = lang || 'text';
                    return `<pre><div class="code-block-header">
                        <span>${language}</span>
                        <button class="copy-code-btn" onclick="copyCode(this)">Copy</button>
                    </div><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
                })

                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')

                // Blockquotes
                .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')

                // Lists
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')

                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')

                // Single line breaks within paragraphs become spaces (for natural flow)
                .replace(/\n/g, ' ');

            // Wrap list items in ul tags
            if (p.includes('<li>')) {
                p = '<ul>' + p + '</ul>';
                // Clean up multiple ul tags
                p = p.replace(/<\/ul><ul>/g, '');
            }

            return p;
        })
        .filter(p => p.length > 0) // Remove empty paragraphs
        .join('<br><br>'); // Use double break between paragraphs for proper spacing

    return formatted;
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Entity card rendering for CRUD operations
function renderEntityCard(entityType, action, data) {
    const icons = {
        contact: 'üë§',
        organization: 'üè¢',
        project: 'üìÅ',
        task: '‚úÖ'
    };

    const actionColors = {
        created: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', badge: 'bg-green-100 text-green-800' },
        updated: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', badge: 'bg-blue-100 text-blue-800' },
        deleted: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', badge: 'bg-red-100 text-red-800' }
    };

    const colors = actionColors[action] || actionColors.created;
    const icon = icons[entityType] || 'üìã';
    const entityLabel = entityType.charAt(0).toUpperCase() + entityType.slice(1);
    const actionLabel = action.charAt(0).toUpperCase() + action.slice(1);

    // Build details based on entity type
    let detailsHtml = '';

    if (entityType === 'contact') {
        const url = `/contacts?highlight=${data.id}`;
        detailsHtml = `
            ${data.email ? `<div class="entity-card-detail"><span class="detail-label">Email:</span> <span class="detail-value">${escapeHtml(data.email)}</span></div>` : ''}
            ${data.phone ? `<div class="entity-card-detail"><span class="detail-label">Phone:</span> <span class="detail-value">${escapeHtml(data.phone)}</span></div>` : ''}
            ${data.job_position ? `<div class="entity-card-detail"><span class="detail-label">Position:</span> <span class="detail-value">${escapeHtml(data.job_position)}</span></div>` : ''}
            ${data.organization ? `<div class="entity-card-detail"><span class="detail-label">Organization:</span> <span class="detail-value">${escapeHtml(data.organization)}</span></div>` : ''}
        `;
        return buildCardHtml(icon, entityLabel, actionLabel, data.name, detailsHtml, colors, action !== 'deleted' ? url : null, data.id);
    }

    if (entityType === 'organization') {
        const url = `/organizations?highlight=${data.id}`;
        detailsHtml = `
            ${data.industry ? `<div class="entity-card-detail"><span class="detail-label">Industry:</span> <span class="detail-value">${escapeHtml(data.industry)}</span></div>` : ''}
            ${data.website ? `<div class="entity-card-detail"><span class="detail-label">Website:</span> <span class="detail-value">${escapeHtml(data.website)}</span></div>` : ''}
            ${data.email ? `<div class="entity-card-detail"><span class="detail-label">Email:</span> <span class="detail-value">${escapeHtml(data.email)}</span></div>` : ''}
        `;
        return buildCardHtml(icon, entityLabel, actionLabel, data.name, detailsHtml, colors, action !== 'deleted' ? url : null, data.id);
    }

    if (entityType === 'project') {
        const url = `/projects/${data.id}`;
        const statusBadge = data.status ? `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>` : '';
        const priorityBadge = data.priority ? `<span class="priority-badge priority-${data.priority.toLowerCase()}">${data.priority}</span>` : '';
        detailsHtml = `
            <div class="entity-card-badges">${statusBadge}${priorityBadge}</div>
            ${data.due_date ? `<div class="entity-card-detail"><span class="detail-label">Due:</span> <span class="detail-value">${formatDate(data.due_date)}</span></div>` : ''}
        `;
        return buildCardHtml(icon, entityLabel, actionLabel, data.name, detailsHtml, colors, action !== 'deleted' ? url : null, data.id);
    }

    if (entityType === 'task') {
        const url = data.project_id ? `/projects/${data.project_id}` : '/tasks';
        const statusBadge = data.status ? `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>` : '';
        const priorityBadge = data.priority ? `<span class="priority-badge priority-${data.priority.toLowerCase()}">${data.priority}</span>` : '';
        detailsHtml = `
            <div class="entity-card-badges">${statusBadge}${priorityBadge}</div>
            ${data.assignee ? `<div class="entity-card-detail"><span class="detail-label">Assignee:</span> <span class="detail-value">${escapeHtml(data.assignee)}</span></div>` : ''}
            ${data.due_date ? `<div class="entity-card-detail"><span class="detail-label">Due:</span> <span class="detail-value">${formatDate(data.due_date)}</span></div>` : ''}
        `;
        return buildCardHtml(icon, entityLabel, actionLabel, data.name, detailsHtml, colors, action !== 'deleted' ? url : null, data.id);
    }

    // Default card for unknown entity types
    return buildCardHtml(icon, entityLabel, actionLabel, data.name || 'Unknown', '', colors, null, data.id);
}

function buildCardHtml(icon, entityLabel, actionLabel, name, detailsHtml, colors, url, id) {
    const clickableClass = url ? 'entity-card-clickable' : '';
    const onClickAttr = url ? `onclick="window.location.href='${url}'"` : '';

    return `
        <div class="entity-card ${clickableClass}" ${onClickAttr} data-entity-id="${id}">
            <div class="entity-card-header">
                <div class="entity-card-icon">${icon}</div>
                <div class="entity-card-title-section">
                    <span class="entity-card-type">${entityLabel}</span>
                    <span class="entity-card-action ${colors.badge}">${actionLabel}</span>
                </div>
            </div>
            <div class="entity-card-name">${escapeHtml(name)}</div>
            ${detailsHtml ? `<div class="entity-card-details">${detailsHtml}</div>` : ''}
            ${url ? `<div class="entity-card-footer"><span class="view-link">View ${entityLabel} ‚Üí</span></div>` : ''}
        </div>
    `;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) {
        return dateStr;
    }
}

// Copy functionality
function copyCode(button) {
    const codeBlock = button.closest('pre').querySelector('code');
    const text = codeBlock.textContent;

    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.style.background = 'var(--primary)';
        button.style.color = 'var(--primary-foreground)';

        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '';
            button.style.color = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}


// Form submission handler
document.getElementById('chat-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const message = formData.get('message').trim();

    if (!message) return;

    // Add user message immediately
    addUserMessage(message);

    // Show thinking indicator
    showTyping();

    // Clear input and reset button state
    messageInput.value = '';
    autoResizeTextarea();

    // Reset send button state
    sendButton.style.opacity = '0.7';
    sendButton.style.transform = 'scale(0.9)';
    sendButton.disabled = true;

    // Send JSON request to API
    const jsonData = {
        message: message,
        provider: localStorage.getItem('preferred_ai_provider') || 'claude',
        conversation_history: messageHistory.slice(-5).map(msg => [
            {role: "user", content: msg.user},
            {role: "assistant", content: msg.assistant}
        ]).flat()
    };

    fetch('/api/v1/chat/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('access_token') || '')
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        hideTyping();
        addAssistantMessage(data);
        messageHistory.push({
            user: message,
            assistant: data.response
        });
    })
    .catch(error => {
        hideTyping();
        console.error('Chat error:', error);
        addAssistantMessage({
            response: 'Sorry, I encountered an error processing your message. Please try again.',
            provider: 'Error',
            command_detected: false
        });
    });
});

// Enhanced textarea functionality and input interactions
const messageInput = document.getElementById('message-input');
const sendButton = document.querySelector('.send-button-modern');
const sendIcon = document.querySelector('.send-icon');
const checkIcon = document.querySelector('.check-icon');
const inputWrapper = document.querySelector('.chat-input-wrapper');

// Auto-focus on input
messageInput.focus();

// Auto-resize textarea
function autoResizeTextarea() {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
}

// Handle textarea input with auto-resize and button state management
messageInput.addEventListener('input', function() {
    autoResizeTextarea();

    // Dynamic send button state based on input content
    const hasContent = this.value.trim().length > 0;
    if (hasContent) {
        sendButton.style.opacity = '1';
        sendButton.style.transform = 'scale(1)';
        sendButton.disabled = false;
    } else {
        sendButton.style.opacity = '0.7';
        sendButton.style.transform = 'scale(0.9)';
        sendButton.disabled = true;
    }
});

// Handle enter key (send on Enter, new line on Shift+Enter)
messageInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (!sendButton.disabled) {
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }
    }
});

// Add focus state management
messageInput.addEventListener('focus', function() {
    inputWrapper.classList.add('focused');
});

messageInput.addEventListener('blur', function() {
    inputWrapper.classList.remove('focused');
});

// Send button animation
function animateSendButton() {
    sendButton.classList.add('sending');
    checkIcon.classList.remove('hidden');
    sendIcon.classList.add('hidden');

    setTimeout(() => {
        sendButton.classList.remove('sending');
        checkIcon.classList.add('hidden');
        sendIcon.classList.remove('hidden');
    }, 1500);
}

// Initialize send button state
sendButton.style.opacity = '0.7';
sendButton.style.transform = 'scale(0.9)';
sendButton.disabled = true;


// Load user's preferred AI provider
fetch('/api/v1/chat/providers', {
    headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('access_token') || '')
    }
})
.then(response => response.json())
.then(data => {
    if (data.user_preference) {
        document.getElementById('ai-provider').value = data.user_preference;
    }
})
.catch(error => console.log('Could not load AI provider preference'));

// Initialize scroll
setTimeout(scrollToBottom, 100);

// Scroll to bottom button functionality
const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
const chatMessagesContainer = document.getElementById('chat-messages');

// Show/hide scroll to bottom button based on scroll position
chatMessagesContainer.addEventListener('scroll', function() {
    const isAtBottom = chatMessagesContainer.scrollTop + chatMessagesContainer.clientHeight >= chatMessagesContainer.scrollHeight - 50;

    if (isAtBottom) {
        scrollToBottomBtn.classList.add('hidden');
    } else {
        scrollToBottomBtn.classList.remove('hidden');
    }
});

// Handle scroll to bottom button click
scrollToBottomBtn.addEventListener('click', function() {
    scrollToBottom();
    scrollToBottomBtn.classList.add('hidden');
});

// Enhanced scroll function with smooth behavior
function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
    });
}

</script>
{% endblock %}